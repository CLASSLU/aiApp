# 部署指南

## 1. 环境准备

### 1.1 必要软件安装
- **Docker**: 19.03.0+
- **Docker Compose**: 1.27.0+
- **Git**: 2.0+

### 1.2 安装步骤（Linux）
```bash
# 安装 Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

### 1.3 获取项目代码
```bash
git clone https://github.com/your-username/aiApp.git
cd aiApp
```

## 2. 配置环境变量

### 2.1 创建环境变量文件
```bash
# 复制示例配置文件
cp .env.example .env

# 编辑配置文件，填入您的API密钥
nano .env
```

### 2.2 环境变量说明
必须配置以下环境变量：
- `SILICONFLOW_API_KEY`: SiliconFlow API访问密钥
- `LOG_LEVEL`: 日志级别，推荐生产环境设置为"INFO"

**重要安全提示**: 
- 不要将包含真实API密钥的.env文件提交到代码仓库
- 生产环境应使用安全的密钥管理服务

## 3. 开发环境部署

### 3.1 使用Docker Compose启动服务
```bash
# 构建容器
docker-compose build

# 启动服务
docker-compose up
```

### 3.2 验证部署
- 后端API: http://localhost:5000
- 前端界面: http://localhost:3000
- 健康检查: http://localhost:5000/health

## 4. 生产环境部署

### 4.1 生产环境配置
创建生产环境配置文件 `docker-compose.prod.yml`:

```yaml
version: '3.8'

services:
  backend:
    build: ./src
    restart: always
    ports:
      - "5000:5000"
    volumes:
      - ./logs:/app/logs
    environment:
      - SILICONFLOW_API_KEY=${SILICONFLOW_API_KEY}
      - LOG_LEVEL=INFO
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  frontend:
    build: ./frontend
    restart: always
    ports:
      - "80:80"
    depends_on:
      - backend
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  nginx:
    image: nginx:alpine
    ports:
      - "443:443"
    volumes:
      - ./nginx/conf:/etc/nginx/conf.d
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - frontend
      - backend
```

### 4.2 启动生产服务
```bash
# 设置环境变量（可以使用.env文件或在服务器环境中设置）
export SILICONFLOW_API_KEY=your_production_key

# 构建并启动服务
docker-compose -f docker-compose.prod.yml build
docker-compose -f docker-compose.prod.yml up -d
```

## 5. 监控和日志管理

### 5.1 监控端点
- Prometheus 指标端点：`/metrics`
- 健康检查端点：`/health`

### 5.2 查看容器日志
```bash
# 查看后端日志
docker-compose logs -f backend

# 查看前端日志
docker-compose logs -f frontend
```

### 5.3 设置日志轮转
创建 `./docker/logging.json` 文件:
```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

## 6. 版本管理和更新流程

### 6.1 更新应用程序
```bash
# 获取最新代码
git pull

# 重新构建并重启服务
docker-compose -f docker-compose.prod.yml build
docker-compose -f docker-compose.prod.yml up -d
```

### 6.2 版本回滚
```bash
# 切换到特定版本
git checkout v1.0.0

# 重新构建并重启服务
docker-compose -f docker-compose.prod.yml build
docker-compose -f docker-compose.prod.yml up -d
```

## 7. 安全配置

### 7.1 配置HTTPS
1. 获取SSL证书（可使用Let's Encrypt）
2. 将证书放置在 `./nginx/ssl/` 目录
3. 配置Nginx（`./nginx/conf/default.conf`）:

```nginx
server {
    listen 443 ssl;
    server_name yourdomain.com;

    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;

    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api {
        proxy_pass http://backend:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

server {
    listen 80;
    server_name yourdomain.com;
    return 301 https://$host$request_uri;
}
```

### 7.2 防火墙配置
只开放必要端口：80, 443

## 8. 故障排除指南

### 8.1 常见问题
| 问题 | 解决方案 |
|------|----------|
| API密钥错误 | 检查.env文件中的SILICONFLOW_API_KEY是否正确 |
| 容器无法启动 | 检查Docker日志: `docker-compose logs` |
| 前端无法连接后端 | 确保后端服务正常运行，检查网络配置 |
| 内存不足错误 | 增加Docker分配的内存，或优化应用程序 |

### 8.2 检查服务状态
```bash
# 检查所有容器状态
docker-compose ps

# 检查资源使用情况
docker stats
```

## 9. 性能优化

### 9.1 应用程序优化
- 配置合适的gunicorn工作进程数（通常为CPU核心数的2倍）
- 优化前端资源（压缩JS/CSS，使用CDN）

### 9.2 Docker优化
- 使用多阶段构建减小镜像大小
- 配置资源限制防止单个服务占用过多资源

### 9.3 扩展策略
对于高负载场景，考虑：
- 水平扩展后端服务
- 使用负载均衡器
- 实施缓存策略